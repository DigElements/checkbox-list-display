<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../dig-common/dig-common.html">

<!--
An element used to display checkboxes for filtering.

Example:

    <checkbox-list-display
        buckets="[[countryResult.aggregations.countryAgg.countryAgg.buckets]]"
        facet-selection="{{countryFacetSelection}}"
        facets="{{countryFacets}}"
        category="Country">
    </checkbox-list-display>

@demo demo/index.html
-->

<dom-module id="checkbox-list-display">
  <template>
    <style>
      :host {
        display: block;
      }
      iron-image {
        height: 50px;
        width: 50px;
      }
    </style>

    <template is="dom-repeat" items="{{facets}}" as="facet">
      <paper-checkbox name="[[facet.key]]" checked="{{facet.enabled}}" on-tap="_updateFacetSelection" class="layout horizontal">
        <template is="dom-if" if="[[images]]">
          <iron-image class$="[[imageStyleClass]]" src="[[facet.text]]" sizing="contain"></iron-image>
          [[_getFacetCount(facet)]]
        </template>
        <template is="dom-if" if="[[!images]]">
          [[_getFacetContent(facet)]]
        </template>
      </paper-checkbox>
    </template>
  </template>

  <script>
    Polymer({
      is: 'checkbox-list-display',

      properties: {
        /**
         * The list of buckets from an elastic search aggregation result.
         *
         * @type {Array}
         */
        buckets: {
          type: Array
        },

        /**
         * Computed list of facet buckets used for displaying checkboxes.
         *
         * @type [{text: 'Los Angeles, CA', key: 'Los Angeles', count: 10, enabled: true}]
         * @default []
         */
        facets: {
          type: Array,
          value: function() {
            return [];
          },
          computed: '_extractFacets(buckets.*)',
          notify: true
        },

        /**
         * Contains state of facet checkboxes to persist selection state between queries.
         *
         * @type {{'Los Angeles': {text: 'Los Angeles, CA', key: 'Los Angeles', enabled: true, category: 'City'}}}
         * @default {}
         */
        facetSelection: {
          type: Object,
          value: function() {
            return {};
          },
          notify: true
        },

        /**
         * If aggregation has many buckets, show only the first few.
         *
         * @type {Number}
         * @default 10
         */
        show: {
          type: Number,
          value: 10
        },

        /**
         * Identifier for checkbox filter set
         *
         * @type {String}
         */
        category: {
          type: String
        },

        /**
         * Whether to show the text in the checkboxes as images.
         *
         * @type {Boolean}
         * @default false
         */
        images: {
          type: Boolean,
          value: false
        },

        /**
         * The style class for images (if the "images" property is true).
         *
         * @type {String}
         * @default ''
         */
        imageStyleClass: {
          type: String,
          value: ''
        }
      },

      /**
       * Builds the state of the facet checkboxes based on the inputted
       * buckets list and the saved state of selections
       *
       * @param {Array} Buckets obtained via elasticsearch
       * @return {Array} facets
       * @private
       */
      _extractFacets: function(buckets) {
        var me = this;
        var facets = {};
        var facetsList = [];
        _.each(buckets.value, function(bucket) {
          facets[bucket.key] = {
            text: (bucket.text) ? bucket.text : bucket.key,
            key: bucket.key,
            count: bucket.doc_count,
            enabled: (me.facetSelection[bucket.key] ? me.facetSelection[bucket.key].enabled : false)
          };

          facetsList.push(facets[bucket.key]);

          if(me.show !== 0 && facetsList.length === me.show) {
            return false;
          }
        });
        return facetsList;
      },      

      /**
       * When checkbox is tapped, update the specified facet to be enabled or disabled.
       *
       * @event tap
       * @private
       */
      _updateFacetSelection: function(event) {
        var facet = event.model.facet;

        this.facetSelection[facet.key] = {
          text: facet.text,
          key: facet.key,
          enabled: facet.enabled,
          category: this.category
        };

        this.notifyPath('facetSelection.*', {
          text: facet.text,
          key: facet.key,
          enabled: facet.enabled,
          category: this.category
        });
      },

      /**
       * Returns the content for the checkbox containing the given facet.
       *
       * @param {Object} facet
       * @return {String}
       * @private
       */
      _getFacetContent: function(facet) {
        // Use regex replace to add commas to count.
        return facet.text + ' ' + this._getFacetCount(facet);
      },

      /**
       * Returns the count text for the checkbox containing the given facet.
       *
       * @param {Object} facet
       * @return {String}
       * @private
       */
      _getFacetCount: function(facet) {
        return (facet.count ? '(' + facet.count.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',') + ')' : '');
      }
    });
  </script>
</dom-module>
